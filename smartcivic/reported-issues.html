<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Reported Issues</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="sidebar">
    <h2>Admin Panel</h2>
    <a href="index.html">üè† Dashboard</a>
    <a href="reported-issues.html" class="active">üêû Reported Issues</a>
    <a href="live-map.html">üó∫Ô∏è Live Map</a>
    <a href="task-assignment.html">üìã Task Assignment</a>
    <a href="resolved-reports.html">‚úÖ Resolved Reports</a>
    <a href="admin-settings.html">‚öôÔ∏è Settings</a>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>

  <div class="main">
    <header><h1>Reported Issues</h1></header>
    <div class="container" id="issues-container">
      <p>Loading issues...</p>
    </div>
  </div>

  <!-- Firebase imports -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    // ‚úÖ Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBGW0FVMF2gjDChPcbMbfdkY3zp9LaiISE",
      authDomain: "my-civic-pro.firebaseapp.com",
      projectId: "my-civic-pro",
      storageBucket: "my-civic-pro.firebasestorage.app",
      messagingSenderId: "457064350295",
      appId: "1:457064350295:web:cfdbac285c7fe1e533d912"
    };

    // ‚úÖ Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const issuesContainer = document.getElementById("issues-container");

    // ‚úÖ Format Firestore timestamp
    function formatTimestamp(ts) {
      if (!ts) return "N/A";
      try {
        if (ts.toDate) return ts.toDate().toLocaleString();
        if (ts.seconds) return new Date(ts.seconds * 1000).toLocaleString();
        return new Date(ts).toLocaleString();
      } catch {
        return "N/A";
      }
    }

    // ‚úÖ Create issue card
    function createCard(docSnap) {
      const id = docSnap.id;
      const data = docSnap.data();

      const card = document.createElement("div");
      card.className = "card";

      const title = data.title || "Untitled";
      const description = data.description || "";
      const status = data.status || "Submitted";
      const assigned = data.assignedTo || "Not assigned";
      const location = data.location
        ? `${data.location.lat || ""}, ${data.location.lng || ""}`
        : "Unknown location";
      const createdAt = formatTimestamp(data.createdAt);
      const resolvedAt = formatTimestamp(data.resolvedDate);

      card.innerHTML = `
        <h3>${title}</h3>
        <p><strong>Status:</strong> ${status} | <strong>Assigned To:</strong> ${assigned}</p>
        <p><strong>Location:</strong> ${location}</p>
        <p><strong>Reported On:</strong> ${createdAt}</p>
        ${status === "Resolved" ? `<p><strong>Resolved On:</strong> ${resolvedAt}</p>` : ""}
        <p>${description}</p>
        <div style="display:flex;gap:8px;margin-top:8px;">
          <button id="view-${id}">View Image</button>
          <button id="assign-${id}">Assign</button>
          <button id="resolve-${id}">Mark Resolved</button>
        </div>
      `;

      // ‚úÖ View Image
      card.querySelector(`#view-${id}`).addEventListener("click", () => {
        if (data.imageUrl && data.imageUrl.length) {
          window.open(data.imageUrl, "_blank");
        } else {
          alert("No image available.");
        }
      });

      // ‚úÖ Assign to department
      card.querySelector(`#assign-${id}`).addEventListener("click", async () => {
        const dept = prompt("Assign to department (e.g., Roads, Sanitation, Electrical, Water):", assigned);
        if (!dept) return;
        try {
          await updateDoc(doc(db, "reportapp", id), { assignedTo: dept, status: "Assigned" });
          alert("Assigned to " + dept);
        } catch (err) {
          console.error(err);
          alert("Failed to assign.");
        }
      });

      // ‚úÖ Mark as resolved
      card.querySelector(`#resolve-${id}`).addEventListener("click", async () => {
        if (!confirm("Mark this issue as resolved?")) return;
        try {
          await updateDoc(doc(db, "reportapp", id), { status: "Resolved", resolvedDate: serverTimestamp() });
          alert("Marked as resolved.");
        } catch (err) {
          console.error(err);
          alert("Failed to mark resolved.");
        }
      });

      return card;
    }

    // ‚úÖ Real-time listener
    onSnapshot(collection(db, "reportapp"), (snapshot) => {
      issuesContainer.innerHTML = "";
      if (snapshot.empty) {
        issuesContainer.innerHTML = "<p>No issues reported yet.</p>";
        return;
      }
      snapshot.forEach(docSnap => {
        const card = createCard(docSnap);
        issuesContainer.appendChild(card);
      });
    }, (err) => {
      console.error(err);
      issuesContainer.innerHTML = "<p style='color:red;'>Failed to load issues.</p>";
    });
  </script>

  <!-- Global script for logout -->
  <script src="script.js"></script>
</body>
</html>
