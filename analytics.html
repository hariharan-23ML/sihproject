<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Analytics | Civic Dashboard</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="sidebar">
    <h2>Civic Dashboard</h2>
    <a href="index.html">🏠 Dashboard</a>
    <a href="reported-issues.html">🐞 Reported Issues</a>
    <a href="live-map.html">🗺️ Live Map</a>
    <a href="analytics.html" class="active">📊 Analytics</a>
    <a href="task-assignment.html">📝 Task Assignment</a>
    <a href="resolved-reports.html">✅ Resolved Reports</a>
    <a href="admin-settings.html">⚙️ Settings</a>
  </div>

  <div class="main">
    <header><h1>Analytics</h1></header>
    <canvas id="chart1"></canvas>
    <canvas id="chart2" style="margin-top:40px;"></canvas>
    <footer>&copy; 2025 Civic Issue Reporting</footer>
  </div>

  <script type="module">
    import { db } from "./firebase.js";
    import { collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    let chart1 = null;
    let chart2 = null;

    function monthName(date) {
      return date.toLocaleString('default', { month: 'short' });
    }

    onSnapshot(collection(db, "reportapp"), (snapshot) => {
      const statusCounts = { Submitted:0, Assigned:0, "In Progress":0, Resolved:0, Pending:0 };
      const monthly = { Jan:0, Feb:0, Mar:0, Apr:0, May:0, Jun:0, Jul:0, Aug:0, Sep:0, Oct:0, Nov:0, Dec:0 };

      snapshot.forEach(doc => {
        const d = doc.data();
        const st = (d.status || "Submitted").trim().toLowerCase();

        // normalize status
        if(st === "resolved") statusCounts.Resolved++;
        else if(st === "assigned") statusCounts.Assigned++;
        else if(st === "in progress") statusCounts["In Progress"]++;
        else if(st === "pending") statusCounts.Pending++;
        else statusCounts.Submitted++;

        // monthly count
        if(d.createdAt && d.createdAt.toDate){
          const dt = d.createdAt.toDate();
          const m = monthName(dt);
          if(monthly[m] !== undefined) monthly[m]++;
        }
      });

      // Chart 1: Status
      const ctx1 = document.getElementById("chart1").getContext("2d");
      if(chart1) chart1.destroy();
      chart1 = new Chart(ctx1, {
        type: "bar",
        data: {
          labels: Object.keys(statusCounts),
          datasets: [{
            data: Object.values(statusCounts),
            backgroundColor: ['#e74c3c','#f39c12','#3498db','#2ecc71','#9b59b6']
          }]
        },
        options: { responsive:true }
      });

      // Chart 2: Monthly
      const ctx2 = document.getElementById("chart2").getContext("2d");
      if(chart2) chart2.destroy();
      chart2 = new Chart(ctx2, {
        type: "line",
        data: {
          labels: Object.keys(monthly),
          datasets: [{
            label: 'Reports per Month',
            data: Object.values(monthly),
            borderColor: '#2e7d32',
            fill: false
          }]
        },
        options: { responsive:true }
      });

    }, (err) => console.error("Analytics snapshot error:", err));
  </script>

  <script src="script.js"></script>
</body>
</html>
